name: Update Flatpak Manifest

on:
  workflow_dispatch: # Manual trigger
  push:
    paths:
      - "pubspec.yaml"
      - "pubspec.lock"
      - "flatpak-flutter.yml"

jobs:
  update-manifest:
    name: Update Manifest
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install flatpak-flutter dependencies
        run: |
          pip install packaging pyyaml toml

      - name: Clone flatpak-flutter
        run: |
          git clone https://github.com/TheAppgineer/flatpak-flutter.git
          cd flatpak-flutter
          echo "flatpak-flutter version:"
          python3 flatpak-flutter.py --version

      - name: Run flatpak-flutter preprocessor
        run: |
          cd flatpak-flutter

          # Patch flatpak-flutter.py to fix missing l10n file issue by modifying l10n.yaml
          cat <<EOF > patch_script.py
          import os
          from pathlib import Path

          file_path = 'flatpak-flutter.py'
          with open(file_path, 'r') as f:
              lines = f.readlines()

          with open(file_path, 'w') as f:
              for line in lines:
                  if 'if tag is not None:' in line:
                      indent = line[:line.find('if')]
                      f.write(indent + "# PATCH: Fix setup-flutter.sh path\n")
                      f.write(indent + "for module in manifest.get('modules', []):\n")
                      f.write(indent + "    if module.get('name') == app_module:\n")
                      f.write(indent + "        cmds = module.get('build-commands', [])\n")
                      f.write(indent + "        for i, cmd in enumerate(cmds):\n")
                      f.write(indent + "            if cmd.strip().startswith('setup-flutter.sh'):\n")
                      f.write(indent + "                cmds[i] = '/var/lib/flutter/bin/' + cmd.strip()\n")
                      f.write(indent + "                print(f'DEBUG: Updated command to {cmds[i]}')\n")
                  f.write(line)
                  if 'full_pubspec_path =' in line:
                      indent = line[:line.find('full_pubspec_path')]
                      f.write(indent + "print(f'DEBUG: Patching l10n.yaml in {full_pubspec_path}')\n")
                      f.write(indent + "try:\n")
                      f.write(indent + "    l10n_yaml = Path(full_pubspec_path) / 'l10n.yaml'\n")
                      f.write(indent + "    if l10n_yaml.exists():\n")
                      f.write(indent + "        with open(l10n_yaml, 'r') as yf: lines_y = yf.readlines()\n")
                      f.write(indent + "        with open(l10n_yaml, 'w') as yf:\n")
                      f.write(indent + "            for ly in lines_y:\n")
                      f.write(indent + "                if 'untranslated-messages-file' not in ly:\n")
                      f.write(indent + "                    yf.write(ly)\n")
                      f.write(indent + "        print('DEBUG: Removed untranslated-messages-file from l10n.yaml')\n")
                      f.write(indent + "    # Ensure output dir exists anyway\n")
                      f.write(indent + "    l10n_dir = Path(full_pubspec_path) / 'lib' / 'generated' / 'lang'\n")
                      f.write(indent + "    l10n_dir.mkdir(parents=True, exist_ok=True)\n")
                      f.write(indent + "except Exception as e:\n")
                      f.write(indent + "    print(f'DEBUG: Failed to patch l10n.yaml: {e}')\n")
          EOF
          python3 patch_script.py

          python3 flatpak-flutter.py ../flatpak-flutter.yml --app-pubspec hisnelmoslem

          # Move generated manifest and dependencies to root
          if [ -f "com.hassaneltantawy.hisnelmoslem.yml" ]; then
            mv com.hassaneltantawy.hisnelmoslem.yml ..
            mv pubspec-sources.json .. 2>/dev/null || true
            mv flutter-sdk-*.json .. 2>/dev/null || true
            mv package_config.json .. 2>/dev/null || true
            mv flutter-shared.sh.patch .. 2>/dev/null || true
            mv cargo-sources.json .. 2>/dev/null || true
          fi

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add all potential generated files
          git add com.hassaneltantawy.hisnelmoslem.yml pubspec-sources.json flutter-sdk-*.json package_config.json flutter-shared.sh.patch cargo-sources.json || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Update Flatpak manifest"
            git push
          fi