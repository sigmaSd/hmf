name: Generate Flatpak Manifest

on:
  workflow_dispatch: # Manual trigger
  push:
    paths:
      - "pubspec.yaml"
      - "pubspec.lock"
      - "flatpak-flutter.yml"

jobs:
  generate-manifest:
    name: Preprocess with flatpak-flutter
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install flatpak-flutter dependencies
        run: |
          pip install packaging pyyaml toml

      - name: Clone flatpak-flutter
        run: |
          git clone https://github.com/TheAppgineer/flatpak-flutter.git
          cd flatpak-flutter
          echo "flatpak-flutter version:"
          python3 flatpak-flutter.py --version

      - name: Run flatpak-flutter preprocessor
        run: |
          cd flatpak-flutter

          # Patch flatpak-flutter.py to fix missing l10n file issue by modifying l10n.yaml
          cat <<EOF > patch_script.py
          import os
          from pathlib import Path

          file_path = 'flatpak-flutter.py'
          with open(file_path, 'r') as f:
              lines = f.readlines()

          with open(file_path, 'w') as f:
              for line in lines:
                  if 'if tag is not None:' in line:
                      indent = line[:line.find('if')]
                      f.write(indent + "# PATCH: Fix setup-flutter.sh path\n")
                      f.write(indent + "for module in manifest.get('modules', []):\n")
                      f.write(indent + "    if module.get('name') == app_module:\n")
                      f.write(indent + "        cmds = module.get('build-commands', [])\n")
                      f.write(indent + "        for i, cmd in enumerate(cmds):\n")
                      f.write(indent + "            if cmd.strip().startswith('setup-flutter.sh'):\n")
                      f.write(indent + "                cmds[i] = '/var/lib/flutter/bin/' + cmd.strip()\n")
                      f.write(indent + "                print(f'DEBUG: Updated command to {cmds[i]}')\n")
                  f.write(line)
                  if 'full_pubspec_path =' in line:
                      indent = line[:line.find('full_pubspec_path')]
                      f.write(indent + "print(f'DEBUG: Patching l10n.yaml in {full_pubspec_path}')\n")
                      f.write(indent + "try:\n")
                      f.write(indent + "    l10n_yaml = Path(full_pubspec_path) / 'l10n.yaml'\n")
                      f.write(indent + "    if l10n_yaml.exists():\n")
                      f.write(indent + "        with open(l10n_yaml, 'r') as yf: lines_y = yf.readlines()\n")
                      f.write(indent + "        with open(l10n_yaml, 'w') as yf:\n")
                      f.write(indent + "            for ly in lines_y:\n")
                      f.write(indent + "                if 'untranslated-messages-file' not in ly:\n")
                      f.write(indent + "                    yf.write(ly)\n")
                      f.write(indent + "        print('DEBUG: Removed untranslated-messages-file from l10n.yaml')\n")
                      f.write(indent + "    # Ensure output dir exists anyway\n")
                      f.write(indent + "    l10n_dir = Path(full_pubspec_path) / 'lib' / 'generated' / 'lang'\n")
                      f.write(indent + "    l10n_dir.mkdir(parents=True, exist_ok=True)\n")
                      f.write(indent + "except Exception as e:\n")
                      f.write(indent + "    print(f'DEBUG: Failed to patch l10n.yaml: {e}')\n")
          EOF
          python3 patch_script.py

          python3 flatpak-flutter.py ../flatpak-flutter.yml --app-pubspec hisnelmoslem

          # Move generated manifest and dependencies to root
          if [ -f "com.hassaneltantawy.hisnelmoslem.yml" ]; then
            mv com.hassaneltantawy.hisnelmoslem.yml ..
            mv pubspec-sources.json .. 2>/dev/null || true
            mv flutter-sdk-*.json .. 2>/dev/null || true
            mv package_config.json .. 2>/dev/null || true
            mv flutter-shared.sh.patch .. 2>/dev/null || true
            mv cargo-sources.json .. 2>/dev/null || true
          fi

          if [ -f "../com.hassaneltantawy.hisnelmoslem.yml" ]; then
            echo "âœ“ Generated manifest: com.hassaneltantawy.hisnelmoslem.yml"
            ls -lh ../com.hassaneltantawy.hisnelmoslem.yml
          else
            echo "ERROR: Manifest generation failed"
            exit 1
          fi

      - name: Check for changes
        id: check_changes
        run: |
          if [ -f "com.hassaneltantawy.hisnelmoslem.yml" ]; then
            if git diff --quiet com.hassaneltantawy.hisnelmoslem.yml 2>/dev/null; then
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "No changes detected"
            else
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "Changes detected in generated manifest"
            fi
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "New manifest generated"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: Update Flatpak manifest

            Auto-generated using flatpak-flutter preprocessor.
          committer: GitHub Actions <github-actions[bot]@users.noreply.github.com>
          author: GitHub Actions <github-actions[bot]@users.noreply.github.com>
          branch: update-flatpak-manifest-${{ github.run_number }}
          delete-branch: true
          title: "chore: Update generated Flatpak manifest"
          body: |
            ## ðŸ¤– Automated Flatpak Manifest Update

            This PR updates the generated Flatpak manifest using `flatpak-flutter` preprocessor.

            ### What happened
            - âœ… Ran `flatpak-flutter` on `flatpak-flutter.yml`
            - âœ… Generated `com.hassaneltantawy.hisnelmoslem.yml` with all dependencies
            - âœ… All pub.dev packages collected for offline build

            ### Changes
            The generated manifest includes:
            - Flutter SDK module
            - All Dart package sources from pub.dev
            - Adjusted build commands for offline build

            ### Details
            - **Triggered by:** `${{ github.event_name }}`
            - **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### How to test
            ```bash
            # Install flatpak-flutter (if not using Docker)
            pip install packaging pyyaml toml

            # Test the generated manifest
            flatpak-builder --force-clean --sandbox build-dir com.hassaneltantawy.hisnelmoslem.yml
            ```

            ### Notes
            - This manifest is auto-generated from `flatpak-flutter.yml`
            - Do NOT edit `com.hassaneltantawy.hisnelmoslem.yml` directly
            - Edit `flatpak-flutter.yml` instead and regenerate

            ---
            Generated by flatpak-flutter preprocessor
          labels: |
            dependencies
            flatpak
            automated

      - name: Upload generated manifest
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-flatpak-manifest
          path: com.hassaneltantawy.hisnelmoslem.yml
          retention-days: 30
          if-no-files-found: warn

      - name: Job Summary
        if: always()
        run: |
          echo "## Flatpak Manifest Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "com.hassaneltantawy.hisnelmoslem.yml" ]; then
            SIZE=$(du -h com.hassaneltantawy.hisnelmoslem.yml | cut -f1)
            LINES=$(wc -l < com.hassaneltantawy.hisnelmoslem.yml)
            echo "âœ… **Success!** Generated manifest" >> $GITHUB_STEP_SUMMARY
            echo "- **File:** com.hassaneltantawy.hisnelmoslem.yml" >> $GITHUB_STEP_SUMMARY
            echo "- **Size:** $SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- **Lines:** $LINES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the PR" >> $GITHUB_STEP_SUMMARY
            echo "2. Test locally with \`flatpak-builder --sandbox\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Merge when ready" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Failed** to generate manifest" >> $GITHUB_STEP_SUMMARY
          fi
