name: Generate Flatpak Manifest

on:
  workflow_dispatch: # Manual trigger
  push:
    paths:
      - "pubspec.yaml"
      - "pubspec.lock"
      - "flatpak-flutter.yml"

jobs:
  generate-manifest:
    name: Preprocess with flatpak-flutter
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install flatpak-flutter dependencies
        run: |
          pip install packaging pyyaml toml

      - name: Clone flatpak-flutter
        run: |
          git clone https://github.com/TheAppgineer/flatpak-flutter.git
          cd flatpak-flutter
          echo "flatpak-flutter version:"
          python3 flatpak-flutter.py --version

      - name: Run flatpak-flutter preprocessor
        run: |
          cd flatpak-flutter
          python3 flatpak-flutter.py ../flatpak-flutter.yml --app-pubspec hisnelmoslem

          # Move generated manifest to root
          if [ -f "../com.hassaneltantawy.hisnelmoslem.yml" ]; then
            echo "âœ“ Generated manifest: com.hassaneltantawy.hisnelmoslem.yml"
            ls -lh ../com.hassaneltantawy.hisnelmoslem.yml
          else
            echo "ERROR: Manifest generation failed"
            exit 1
          fi

      - name: Check for changes
        id: check_changes
        run: |
          if [ -f "com.hassaneltantawy.hisnelmoslem.yml" ]; then
            if git diff --quiet com.hassaneltantawy.hisnelmoslem.yml 2>/dev/null; then
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "No changes detected"
            else
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "Changes detected in generated manifest"
            fi
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "New manifest generated"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: Update Flatpak manifest

            Auto-generated using flatpak-flutter preprocessor.
          committer: GitHub Actions <github-actions[bot]@users.noreply.github.com>
          author: GitHub Actions <github-actions[bot]@users.noreply.github.com>
          branch: update-flatpak-manifest-${{ github.run_number }}
          delete-branch: true
          title: "chore: Update generated Flatpak manifest"
          body: |
            ## ðŸ¤– Automated Flatpak Manifest Update

            This PR updates the generated Flatpak manifest using `flatpak-flutter` preprocessor.

            ### What happened
            - âœ… Ran `flatpak-flutter` on `flatpak-flutter.yml`
            - âœ… Generated `com.hassaneltantawy.hisnelmoslem.yml` with all dependencies
            - âœ… All pub.dev packages collected for offline build

            ### Changes
            The generated manifest includes:
            - Flutter SDK module
            - All Dart package sources from pub.dev
            - Adjusted build commands for offline build

            ### Details
            - **Triggered by:** `${{ github.event_name }}`
            - **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### How to test
            ```bash
            # Install flatpak-flutter (if not using Docker)
            pip install packaging pyyaml toml

            # Test the generated manifest
            flatpak-builder --force-clean --sandbox build-dir com.hassaneltantawy.hisnelmoslem.yml
            ```

            ### Notes
            - This manifest is auto-generated from `flatpak-flutter.yml`
            - Do NOT edit `com.hassaneltantawy.hisnelmoslem.yml` directly
            - Edit `flatpak-flutter.yml` instead and regenerate

            ---
            Generated by flatpak-flutter preprocessor
          labels: |
            dependencies
            flatpak
            automated

      - name: Upload generated manifest
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-flatpak-manifest
          path: com.hassaneltantawy.hisnelmoslem.yml
          retention-days: 30
          if-no-files-found: warn

      - name: Job Summary
        if: always()
        run: |
          echo "## Flatpak Manifest Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "com.hassaneltantawy.hisnelmoslem.yml" ]; then
            SIZE=$(du -h com.hassaneltantawy.hisnelmoslem.yml | cut -f1)
            LINES=$(wc -l < com.hassaneltantawy.hisnelmoslem.yml)
            echo "âœ… **Success!** Generated manifest" >> $GITHUB_STEP_SUMMARY
            echo "- **File:** com.hassaneltantawy.hisnelmoslem.yml" >> $GITHUB_STEP_SUMMARY
            echo "- **Size:** $SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- **Lines:** $LINES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the PR" >> $GITHUB_STEP_SUMMARY
            echo "2. Test locally with \`flatpak-builder --sandbox\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Merge when ready" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Failed** to generate manifest" >> $GITHUB_STEP_SUMMARY
          fi
