name: Generate Flatpak Sources (PR)

on:
  workflow_dispatch: # Manual trigger
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: "0 0 * * 1"
  push:
    paths:
      - "pubspec.yaml"
      - "pubspec.lock"

jobs:
  generate-sources:
    name: Generate Flutter Dependencies for Flatpak
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Clone flatpak-builder-tools
        run: |
          set -ex  # Enable command echoing and exit on error

          if [ -d "flatpak-builder-tools" ]; then
            echo "Removing existing flatpak-builder-tools directory..."
            rm -rf flatpak-builder-tools
          fi

          echo "Cloning flatpak-builder-tools..."
          git clone --depth=1 https://github.com/flatpak/flatpak-builder-tools.git

          echo "Verifying clone..."
          ls -la flatpak-builder-tools/

          if [ ! -d "flatpak-builder-tools/dart" ]; then
            echo "ERROR: dart directory not found in flatpak-builder-tools"
            echo "Contents of flatpak-builder-tools:"
            find flatpak-builder-tools -maxdepth 2 -type d
            exit 1
          fi

          if [ ! -f "flatpak-builder-tools/dart/flatpak-dart-generator.py" ]; then
            echo "ERROR: flatpak-dart-generator.py not found"
            echo "Contents of dart directory:"
            ls -la flatpak-builder-tools/dart/
            exit 1
          fi

          echo "âœ“ Successfully cloned flatpak-builder-tools"

      - name: Generate dependency sources
        run: |
          set -ex  # Enable command echoing and exit on error

          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la

          if [ ! -f "pubspec.yaml" ]; then
            echo "ERROR: pubspec.yaml not found in repository root"
            exit 1
          fi

          cd flatpak-builder-tools/dart
          pwd

          echo "Generating sources from pubspec.yaml..."
          python3 flatpak-dart-generator.py ../../pubspec.yaml

          if [ -f "generated-sources.json" ]; then
            echo "âœ“ Generated file size: $(du -h generated-sources.json)"
            mv generated-sources.json ../../
            echo "âœ“ Successfully moved generated-sources.json to repository root"
          else
            echo "ERROR: generated-sources.json was not created"
            echo "Contents of current directory:"
            ls -la
            exit 1
          fi

      - name: Update manifest
        run: |
          # Check if manifest needs updating
          if [ -f "com.hassaneltantawy.hisnelmoslem.yml" ]; then
            if grep -q "# - generated-sources.json" com.hassaneltantawy.hisnelmoslem.yml; then
              sed -i 's/# - generated-sources.json/- generated-sources.json/' com.hassaneltantawy.hisnelmoslem.yml
              echo "âœ“ Uncommented generated-sources.json in manifest"
            elif ! grep -q "generated-sources.json" com.hassaneltantawy.hisnelmoslem.yml; then
              echo "âš  Warning: generated-sources.json not found in manifest"
            else
              echo "âœ“ Manifest already includes generated-sources.json"
            fi
          fi

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet generated-sources.json 2>/dev/null && \
             git diff --quiet com.hassaneltantawy.hisnelmoslem.yml 2>/dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in sources"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: Update Flatpak dependency sources

            Auto-generated Flutter/Dart dependencies for Flatpak build.
          committer: GitHub Actions <github-actions[bot]@users.noreply.github.com>
          author: GitHub Actions <github-actions[bot]@users.noreply.github.com>
          branch: update-flatpak-sources-${{ github.run_number }}
          delete-branch: true
          title: "chore: Update Flatpak dependency sources"
          body: |
            ## ðŸ¤– Automated Flatpak Sources Update

            This PR updates the Flatpak build dependencies.

            ### Changes
            - âœ… Regenerated `generated-sources.json` from current `pubspec.yaml`
            - âœ… Updated manifest to reference generated sources

            ### Details
            - **Triggered by:** `${{ github.event_name }}`
            - **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### How to test
            ```bash
            # Test the Flatpak build
            flatpak-builder --force-clean build-dir com.hassaneltantawy.hisnelmoslem.yml
            ```

            ### Notes
            This PR was automatically created by the `generate-flatpak-sources` workflow.
            If the dependencies in `pubspec.yaml` haven't changed, this PR can be closed.
          labels: |
            dependencies
            flatpak
            automated

      - name: Upload generated sources
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-flatpak-sources
          path: |
            generated-sources.json
            com.hassaneltantawy.hisnelmoslem.yml
          retention-days: 30
          if-no-files-found: error

      - name: Job Summary
        if: always()
        run: |
          echo "## Flatpak Sources Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "generated-sources.json" ]; then
            LINES=$(wc -l < generated-sources.json)
            SIZE=$(du -h generated-sources.json | cut -f1)
            echo "âœ… **Success!** Generated sources file created" >> $GITHUB_STEP_SUMMARY
            echo "- Lines: $LINES" >> $GITHUB_STEP_SUMMARY
            echo "- Size: $SIZE" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Failed** to generate sources" >> $GITHUB_STEP_SUMMARY
          fi
